{% extends "makeaface/base.html" %}
{% load abs %}

{% block htmlhead %}
    <link rel="stylesheet" type="text/css" href="{% url static path="makeaface/gridwall.css" %}">

    <script type="text/javascript">
    var mycam;

    {% block js_data %}
        var faces = [
        {% for event in events %}
            "{{ event.object.links.rel__enclosure.maxwidth__458.href }}"
            {% if forloop.last %}{% else %},{% endif %}
        {% endfor %}
        ];
    {% endblock%}
    </script>
{% endblock %}

{% block content %}
    <div id="toolbar" class="grid">
        <div class="span-6"></div>
        <div class="span-12"><h1>make a face</h1></div>
        <div class="span-6 last">
            {% if user.is_anonymous %}
                <p>Hi! <a href="{% url login %}">Sign in</a> to face</p>
            {% else %}
                <p>Hi, {{ user.display_name }}! <a href="{% url logout %}">Sign out</a></p>
            {% endif %}
        </div>
    </div><br style="clear: both">

    <div id="gridsizer"></div>
    <div id="gridcontainer">

        {% if user.is_authenticated %}
            <div id="camera">
                <button id="take-picture" class="take-picture">Take picture</button>
                <div id="camera-throb">☃</div>
            </div>

            <script type="text/javascript">
                cameraman.url = '{% url static path="makeaface/" %}';
                mycam = cameraman.createCamera({
                    'id': 'camera',
                    'width': spanSize(3),
                    'height': spanSize(3),
                    'sendto': '{% absoluteurl %}{% url upload_photo %}{% endabsoluteurl %}',
                    'errorSending': function(cam, err) { alert('OOPS: ' + err) },
                    'tookPhoto': function(cam) { tookPhoto(cam) },
                    //'droppedPhoto': function(cam) { droppedPhoto(cam) },
                    'sentPhoto': function(cam, url) { sentPhoto(cam, url) }
                });

                $('#take-picture').click(pingPingSnap);

                function pingPingSnap () {
                    mycam.takePhoto();
                }

                function tookPhoto(cam) {
                    $('#camera').addClass('sending');
                    cam.sendPhoto();
                }

                function sentPhoto(cam, url) {
                    cam.dropPhoto();
                    $('#camera').removeClass('sending');

                    // Make a new grid cell with this photo.
                    var newphoto = $('<div/>').addClass('gridcell').css({'top': '0px', 'left': '-154px'});
                    newphoto.append($('<img/>').attr('src', url));
                    $('#gridcontainer').append(newphoto);

                    $('.gridcell').animate({"left": "+=154px"}, "slow");
                }
            </script>

        {% else %}
            <div id="howto">
                <div style="margin: 20px">

            <h1>Make a face. It's easy.</h1>

            <h2><ol>
            <li>Sign in.</li>
            <li>Make a face at your web cam.</li>
            <li>Click the button.</li>
            </ol></h2>

            <h1>Like someone's face? Say so!</h1>

            <h2><ol>
            <li>Click the face you like.</li>
            <li>Click the <big style="color: rgb(204, 0, 0);">♥</big>.</li>
            </ol></h2>

            <h1>That's it!</h1>

            </div></div>
        {% endif %}

        {% for event in events %}
            {% with next_box_loc.next as boxloc %}
            <div class="gridcell" style="left: {{ boxloc.left }}px; top: {{ boxloc.top }}px">
                <img src="{{ event.object.links.rel__enclosure.maxwidth__458.href }}">
            </div>
            {% endwith %}
        {% endfor %}

    </div>

{% endblock %}
